### General utility blocks to provide some simple functions that make the output file more useful:

Block 1 - user_name  This block replaces not-logged-in user_name based on an external picklist prepared elsewhere and keyed off user_ip. For volunteers that did not log in, user_name is “not-logged-in-” plus the value in user_ip which is some sort of salted hash of the user’s ip address. Some project owners attempt to identify or group these users by analyzing the user_ip and the platform and browser data in the metadata file. Elsewhere I provide a simple code that does this and produces a csv file with two fields – user_ip and assigned-user_name. The function of this block is to accept and read this file into memory and then, if the user_name in the classification file is noted as “not-logged-in…” the block searches for the user_ip in the read file and replaces the user_name with the assigned_user_name from the read file. The full path and exact filename of the csv file must be modified in the code block if it is to be used. As well a default user_name for the situation no match is found can be specified otherwise the original “not-logged-in-“plus user_ip is retained.

Block 2 - image_number  This block uses an externally built file cross-referencing the subject_ids and an image_number to add a project specific image number to the flattened output file.  NOTE! This code assumes the external picklist is a csv file with two fields 'subject_ids' and 'image_number'.  The external file is read into memory using a function run once to build a dictionary of subject_ids: image_number pairs.  This dictionary then furnishes the correct image number as the frame iterates through the classification records.

Block 3 - image_number  This block attempts to use filenames already present in the subject metadata in the subject_data field of the classification records to generate a image identifier that may be more useful to the project owner than subject_ids. This block searches the subject_data json string of the classification data to pull out specified slices of it based on snippets of text ‘filename’ and ‘.jpg’. If the metadata was carefully constructed and consistent this can solve the problem of cross referencing the project owner’s image identifiers and the zooniverse subject numbers. 

Block 4 - image_number  This block is another attempt to use subject image metadata to generate a image identifier that may be more significant to the project owner. This block searches the subject_data json string of the classification data to pull out specified slices of it based on snippets of text that are part of the **camera image numbers** included in the metadata upload with the subjects. The image_number is constructed in a way that is a sortable and searchable string by rearranging parts of the camera image number.

Block 5 - elapsed_time  This block pulls the started and finished times from the metadata field and calculates the elapsed time the user spent on the classification. In many cases this duration is more useful than the individual started and finished times, for example the elaspsed_time may be very short for bot generated inputs.

Block 6 -  image_size This block attempts to pull the natural height and width for the subject image from the metadata field of the classification record. This info may be needed later to test for out of bounds drawing tools, correctly scale plots, or scale clustering radii or proximity tests. This block searches the metadata json and extracts the original image size in pixels. If not present it reverts to a default which can be modified, either to signal the size was not available or to default to a nominal size.

### The general_utilities_demo files:
#### flatten_class_general_utilities_demo.py 
The file flatten_classification_general_utilities_demo.py is the basic frame flatten_class_frame.py with some of the general utilities blocks from flatten_class_general_utilities.py merged into it. It uses the fossil_finder_classification_test.csv as the input file, and two picklists. One pick list for generating a user_name for higher volume not-logged-in users has two fields 'user_ip' and 'assigned_name' (fossil-finder-classifications_IPusers.csv), while the other, for adding a image-number based on the camera image number has fields 'subject_ids' and 'image_number' (fossil-finder-classifications_image_number.csv).  Note that while in this demo, image_number is a single string, there is no reason it could not be a list or tuple containing other information such as geo-reference coordinates, camera locations, or any other subject specific info the owner wants to import into the flattened classification output file.  Individual items of the imported list can be given their own field in the output file. 
The subject-image_number cross reference in this example was generated from the camera numbers in the subject_data metadata using a script based on the code in Block 4 of flatten_class_general_utilities.py.  That block could also have been used here in place of the second pick list, but I want to demo a file merge. The order of the fields in the output file was modified, and at this point the annotations column has not been flattened (this demo is only to show the general utilities merged with the basic frame). The output file is flatten_class_general_utilities_demo.csv.

#### flatten_class_general_utilities_demo_2.py
The file flatten_class_general_utilities_demo_2.py is a second example, in this case parsing the subject_data field to obtain an image_name from the filename uploaded with the images.  Unlike the previous example above, the comments in the Frame have been left and the order of the output field was not modified - ie this merge has been done with minimal customization using the building blocks as they are, as much as possible. It was tested with the classification download from Amazon Aerobotany. As written it would not work with the fossil-finder-classification_test.csv data since that project does not have file names in the subject_data.  I did not include the input and output files in this repository for this example.
